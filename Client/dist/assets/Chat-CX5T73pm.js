import{n as y,c as w,r,j as e,u as I,L as B,s as T,D as R,_ as C,a as F}from"./index-DDg8tmzP.js";import{u as b,a as O,b as A,B as D,c as L,d as V,e as $,f as P,E as U,g as G,h as Y,i as q,T as z}from"./index-CdBepGEp.js";import{M as k}from"./index-XLCXBP2A.js";import{f as W}from"./format-D5IGutSq.js";import{S as H}from"./sweetalert2.all-BcwuNuaI.js";function J({conversation:s,lastIdx:a}){const{selectedConversation:t,setSelectedConversation:l}=b(),{onlineUsers:n,unreadMessages:d,markAsRead:m}=y(),c=w(h=>h.doctor.doctor),o=(t==null?void 0:t._id)===s._id,i=n.includes(s._id),f=d[s._id]||0,u=f>0,j=()=>{l(s),m(c==null?void 0:c._id,s==null?void 0:s._id)};return r.useEffect(()=>{m(c==null?void 0:c._id,t==null?void 0:t._id)},[]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`flex gap-2 items-center hover:bg-sky-500 p-2 py-2 cursor-pointer ${o?"bg-gray-500":""}`,onClick:j,children:[e.jsx("div",{className:`avatar ${i?"online":""}`,children:e.jsx("div",{className:"w-12 rounded-full",children:e.jsx("img",{src:(s==null?void 0:s.profile)||"/assets/user.png",alt:"user avatar"})})}),e.jsx("div",{className:"flex flex-col flex-1",children:e.jsxs("div",{className:"flex gap-3 justify-between",children:[e.jsx("p",{className:"font-semibold",children:s==null?void 0:s.name}),i?e.jsx("span",{className:"text-green-500 font-bold text-sm",children:"Online"}):e.jsx("span",{className:"text-gray-500 font-bold text-sm",children:"Offline"}),u&&e.jsxs("span",{className:"text-green-500 font-bold text-sm",children:["Messages ",f]})]})})]}),!a&&e.jsx("div",{className:"divider my-0 py-0 h-1"})]})}function K(){const{loading:s,conversations:a}=O(),{selectedConversation:t}=b(),l=t?[t,...a.filter(n=>n._id!==t._id)]:a;return e.jsxs("div",{children:[l.map((n,d)=>e.jsx(J,{conversation:n,lastIdx:d===l.length-1},n==null?void 0:n._id)),s?e.jsx("span",{className:"loading loading-spinner mx-auto",children:"Loading.."}):null]})}function Q(){return e.jsxs("div",{className:"w-1/4 bg-white border-r h-full overflow-y-auto",children:[e.jsx("div",{className:"p-4 bg-blue-700 h-[50px] text-white flex justify-between items-center"}),e.jsx("div",{className:"divider px-3"}),e.jsx(K,{})]})}function X(){const[s,a]=r.useState(""),[t,l]=r.useState(!1),[n,d]=r.useState(!1),[m,c]=r.useState(null),[o,i]=r.useState(null),{loading:f,sendMessage:u}=A(),{startTyping:j,stopTyping:h}=y();r.useEffect(()=>{s?j():h()},[s,j,h]);const N=x=>{a(E=>E+x.emoji)},g=async x=>{x.preventDefault(),!(!s&&!o)&&(s?await u(s):o&&await u(o),a(""),i(null))},p=()=>d(!0),v=()=>d(!1),S=x=>c(x.blob),M=async()=>{m&&(await u(m),c(null))},_=x=>{i(x.target.files[0])};return e.jsxs("form",{className:"px-4 my-3",onSubmit:g,children:[e.jsxs("div",{className:"w-full relative bg-white border-t",children:[e.jsx("input",{type:"text",className:"border text-sm rounded-lg block w-full p-2.5 focus:outline-none focus:ring focus:ring-green-500",placeholder:"Send a message",value:s,onChange:x=>a(x.target.value)}),e.jsx("button",{type:"button",className:"absolute inset-y-0 end-28 flex items-center pe-3",onClick:()=>l(!t),children:e.jsx(D,{})}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",id:"image-upload",onChange:_}),e.jsx("label",{htmlFor:"image-upload",className:"absolute inset-y-0 end-20 flex items-center pe-3 cursor-pointer",children:e.jsx(L,{})}),e.jsx("button",{type:"button",className:"absolute inset-y-0 end-10 flex items-center pe-3",onClick:n?v:p,children:n?e.jsx(V,{}):e.jsx($,{})}),e.jsx("button",{type:"submit",className:"absolute inset-y-0 end-0 flex items-center pe-3",children:f?e.jsx("div",{className:"loading loading-spinner"}):e.jsx(P,{})}),t&&e.jsx("div",{className:"absolute bottom-10 right-0 z-50",children:e.jsx(U,{onEmojiClick:N})}),e.jsx(G.ReactMic,{record:n,className:"hidden",onStop:S,mimeType:"audio/webm"})]}),m&&e.jsxs("div",{className:"flex justify-end mt-2",children:[e.jsx("button",{type:"button",className:"text-white bg-red-500 hover:bg-red-700  px-4 py-2",onClick:()=>{v(),c(null)},children:"Cancel"}),e.jsx("button",{type:"button",className:"text-white bg-green-500 hover:bg-green-700  px-4 py-2",onClick:M,children:"Send Voice Message"})]}),o&&e.jsxs("div",{className:"flex justify-end mt-2",children:[e.jsx("button",{type:"button",className:"text-white bg-red-500 hover:bg-red-700  px-4 py-2",onClick:()=>i(null),children:"Cancel"}),e.jsx("button",{type:"button",className:"text-white bg-green-500 hover:bg-green-700  px-4 py-2",onClick:g,children:"Send Image"})]})]})}const Z=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx("div",{className:"skeleton w-10 h-10 rounded-full shrink-0"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"skeleton h-4 w-40"}),e.jsx("div",{className:"skeleton h-4 w-40"})]})]}),e.jsxs("div",{className:"flex gap-3 items-center justify-end",children:[e.jsx("div",{className:"flex flex-col gap-1",children:e.jsx("div",{className:"skeleton h-4 w-40"})}),e.jsx("div",{className:"skeleton w-10 h-10 rounded-full shrink-0"})]})]});k.setAppElement("#root");function ee({message:s}){const a=w(g=>g.doctor.doctor),{selectedConversation:t}=b(),l=s.senderId===(a==null?void 0:a._id),n=l?"justify-end":"justify-start",d=l?"bg-blue-500":"bg-gray-700",m=(s.senderId===t._id||s.senderId===a._id)&&(s.receiverId===a._id||s.receiverId===t._id),[c,o]=r.useState(!1);if(!m)return null;const i=W(new Date(s.createdAt),"p"),f=s.messageType==="voice",u=s.messageType==="image",j=()=>{o(!0)},h=()=>{o(!1)},N=()=>{const g=s.message;if(!g){console.error("Invalid URL");return}const p=document.createElement("a");p.href=g,p.setAttribute("download",`image_${Date.now()}.jpg`),document.body.appendChild(p),p.click(),document.body.removeChild(p)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`flex ${n} mb-4 mt-2`,children:e.jsxs("div",{className:`relative max-w-xs px-4 py-2 text-white rounded-lg ${d}`,children:[f?e.jsx("video",{className:"h-14 w-64",src:s==null?void 0:s.message,controls:!0}):u?e.jsx("img",{src:s.message,alt:"Sent image",className:"max-w-full h-auto rounded-lg cursor-pointer",onClick:j}):e.jsx("p",{children:s.message}),e.jsx("div",{className:"text-xs text-black-400 mt-1",children:i})]})}),u&&e.jsx(k,{isOpen:c,onRequestClose:h,contentLabel:"Image Preview",className:"flex items-center justify-center",overlayClassName:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-lg w-full mx-4 flex flex-col items-center",children:[e.jsx("div",{className:"w-[290px] h-[290px] flex items-center justify-center mb-4",children:e.jsx("img",{src:s.message,alt:"Image Preview",className:"object-contain max-w-full max-h-full"})}),e.jsx("button",{onClick:N,className:"bg-blue-500 text-white px-4 py-2 w-[115px] mb-4",children:"Download"}),e.jsx("button",{onClick:h,className:"bg-gray-500 text-white px-4 py-2 w-[115px]",children:"Close"})]})})]})}function se(){b();const{messages:s,loading:a}=Y();q();const t=r.useRef();return r.useEffect(()=>{setTimeout(()=>{var l;(l=t.current)==null||l.scrollIntoView({behavior:"smooth"})},100)},[s]),e.jsxs("div",{className:"px-4 flex-1 overflow-auto",children:[!a&&s.length>0&&s.map(l=>e.jsx("div",{ref:t,children:e.jsx(ee,{message:l})},l._id)),a&&[...Array(3)].map((l,n)=>e.jsx(Z,{},n)),!a&&s.length===0&&e.jsx("p",{children:"Send message to start a conversation"})]})}function te({bookingId:s}){var o;const a=I(),{selectedConversation:t,setSelectedConversation:l}=b(),{onlineUsers:n,typingUsers:d}=y(),m=n.includes(t==null?void 0:t._id),c=async()=>{try{(await H.fire({title:"Are you sure?",text:"Once completed, this action cannot be undone!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, mark it as completed!"})).isConfirmed&&((await R.post(`/doctor/consultation/${s._id}`)).status===200?(C.success("Consultation marked as completed successfully"),a("/doctor/Yourbookings")):C.error("Failed to mark consultation as completed"))}catch(i){console.error("Error marking consultation as completed:",i),alert("Failed to mark consultation as completed")}};return r.useEffect(()=>()=>l(null),[l]),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-blue-700 text-white",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:(t==null?void 0:t.profile)||"/assets/user.png",alt:t==null?void 0:t.name,className:"w-12 h-12 rounded-full mr-4"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-lg font-semibold",children:t==null?void 0:t.name}),e.jsx("span",{className:"text-sm text-gray-300",children:d.some(i=>(i==null?void 0:i.userId)===(t==null?void 0:t._id))?"Typing...":m?"Online":""})]})]}),((o=s==null?void 0:s.userId)==null?void 0:o._id)===(t==null?void 0:t._id)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-300",children:"Consulting over?"}),e.jsx("button",{onClick:c,className:"px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-200 ease-in-out transform hover:scale-105",children:"Completed"})]}),e.jsxs(B,{to:"/doctor/Video_chat",state:s.userId._id,className:"px-4 py-2 bg-blue-500 mt-5 text-white rounded-lg shadow-md hover:bg-blue-600 transition duration-200 ease-in-out transform hover:scale-105 flex items-center gap-1",children:[e.jsx(T,{className:"text-white"}),"Video Call"]})]})]}),e.jsx(se,{}),e.jsx(X,{})]}):e.jsx(ae,{})})}const ae=()=>{const s=w(a=>a.doctor.doctor);return e.jsx("div",{className:"flex items-center justify-center w-full h-full bg-black",children:e.jsxs("div",{className:"px-4 text-center sm:text-xl text-green-200 font-semibold flex flex-col items-center gap-2",children:[e.jsxs("p",{children:["Welcome ",s==null?void 0:s.name]}),e.jsx("p",{children:"Select a chat to start messaging"}),e.jsx(z,{className:"text-3xl md:text-6xl text-center"})]})})};function re(){var t;const{setSelectedConversation:s}=b(),a=F();return r.useEffect(()=>{var l,n;(l=a.state)!=null&&l.data&&s((n=a.state.data)==null?void 0:n.userId)},[a.state,s]),e.jsxs("div",{className:"flex h-[88vh] bg-gray-200",children:[e.jsx(Q,{}),e.jsx(te,{bookingId:(t=a.state)==null?void 0:t.data})]})}export{re as default};
